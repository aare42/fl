<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Browse Cases - Financial Literacy Cases</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header>
    <nav>
      <h1>Financial Literacy Cases</h1>
      <ul>
        <li><a href="/">Home</a></li>
        <li><a href="/cases">Browse Cases</a></li>
        <li><a href="/admin">Admin</a></li>
      </ul>
    </nav>
  </header>

  <div class="container">
    <section class="section">
      <h2>Browse Financial Literacy Cases</h2>
      <p>Filter by topic tags to find the perfect case for your lesson</p>

      <div class="filter-section">
        <label class="filter-label">Filter by Topics:</label>
        <div id="tag-filter-buttons" class="tag-filter-buttons">
          <!-- Tag buttons will be dynamically added here -->
        </div>
      </div>

      <div id="selected-tags" style="margin-bottom: 1.5rem;"></div>

      <div id="cases-list">
        <div class="spinner"></div>
      </div>
    </section>
  </div>

  <!-- Case Detail Modal -->
  <div id="case-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title"></h2>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      <div id="modal-body"></div>
    </div>
  </div>

  <script>
    let allCases = [];
    let allTags = [];
    let selectedTags = [];

    // Load all tags
    async function loadTags() {
      try {
        const response = await fetch('/api/cases/meta/tags');
        allTags = await response.json();

        const tagFilterButtons = document.getElementById('tag-filter-buttons');
        tagFilterButtons.innerHTML = allTags.map(tag => `
          <button
            class="tag-filter-btn"
            data-tag="${tag.name}"
            onclick="toggleTag('${tag.name}')"
            style="padding: 0.5rem 1rem; border: 1px solid var(--border-color); border-radius: 0.375rem; background: white; cursor: pointer; font-size: 0.8125rem; transition: all 0.2s; font-weight: 500;"
          >
            ${tag.name}
          </button>
        `).join('');
      } catch (error) {
        console.error('Error loading tags:', error);
      }
    }

    // Load cases
    async function loadCases(tags = []) {
      try {
        let url = '/api/cases';
        if (tags.length > 0) {
          url += '?tags=' + tags.join(',');
        }

        const response = await fetch(url);
        allCases = await response.json();

        displayCases(allCases);
      } catch (error) {
        console.error('Error loading cases:', error);
        document.getElementById('cases-list').innerHTML = `
          <div class="empty-state">
            <p>Unable to load cases at this time.</p>
          </div>
        `;
      }
    }

    // Display cases
    function displayCases(cases) {
      const casesList = document.getElementById('cases-list');

      if (cases.length === 0) {
        casesList.innerHTML = `
          <div class="empty-state">
            <h3>No Cases Found</h3>
            <p>Try selecting different topic filters.</p>
          </div>
        `;
        return;
      }

      casesList.innerHTML = `
        <div class="cases-grid">
          ${cases.map(caseItem => `
            <div class="case-card">
              <div class="case-preview">
                ${caseItem.file_type === '.pdf' ? `
                  <iframe src="/${caseItem.file_path}#toolbar=0&navpanes=0&scrollbar=0" loading="lazy"></iframe>
                ` : `
                  <div class="case-preview-placeholder">
                    <div>ðŸ“„</div>
                    <div class="file-type">TEX Document</div>
                  </div>
                `}
              </div>
              <div class="case-content">
                <h3>${caseItem.name}</h3>
                ${caseItem.description ? `<p>${caseItem.description}</p>` : ''}
                <div class="case-meta">
                  ${caseItem.organization_name ? `<span><strong>Partner:</strong> ${caseItem.organization_name}</span>` : ''}
                  <span><strong>Format:</strong> ${caseItem.file_type.toUpperCase().replace('.', '')}</span>
                </div>
                ${caseItem.tags && caseItem.tags.length > 0 ? `
                  <div class="tags">
                    ${caseItem.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                  </div>
                ` : ''}
                <div class="case-actions">
                  <button class="btn-case btn-case-primary" onclick="viewCase(${caseItem.id})">
                    View Details
                  </button>
                  <a href="/${caseItem.file_path}" download class="btn-case btn-case-download">
                    Download
                  </a>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // Toggle tag selection
    function toggleTag(tag) {
      if (selectedTags.includes(tag)) {
        selectedTags = selectedTags.filter(t => t !== tag);
      } else {
        selectedTags.push(tag);
      }
      updateTagButtons();
      displaySelectedTags();
      loadCases(selectedTags);
    }

    // Update tag button styles
    function updateTagButtons() {
      const buttons = document.querySelectorAll('.tag-filter-btn');
      buttons.forEach(btn => {
        const tag = btn.getAttribute('data-tag');
        if (selectedTags.includes(tag)) {
          btn.style.background = 'var(--primary-color)';
          btn.style.color = 'white';
          btn.style.borderColor = 'var(--primary-color)';
        } else {
          btn.style.background = 'white';
          btn.style.color = 'var(--text-dark)';
          btn.style.borderColor = 'var(--border-color)';
        }
      });
    }

    // Display selected tags
    function displaySelectedTags() {
      const selectedTagsDiv = document.getElementById('selected-tags');
      if (selectedTags.length === 0) {
        selectedTagsDiv.innerHTML = '';
        return;
      }

      selectedTagsDiv.innerHTML = `
        <div style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
          <span style="font-weight: 500;">Active filters:</span>
          ${selectedTags.map(tag => `
            <span class="tag" style="display: inline-flex; align-items: center; gap: 0.5rem;">
              ${tag}
              <button onclick="toggleTag('${tag}')" style="background: none; border: none; color: white; cursor: pointer; font-size: 1.125rem; line-height: 1;">&times;</button>
            </span>
          `).join('')}
          <button onclick="clearFilters()" style="padding: 0.25rem 0.75rem; background: white; border: 1px solid var(--border-color); border-radius: 1rem; cursor: pointer; font-size: 0.875rem;">Clear All</button>
        </div>
      `;
    }

    // Clear filters
    function clearFilters() {
      selectedTags = [];
      updateTagButtons();
      displaySelectedTags();
      loadCases();
    }

    // View case detail
    async function viewCase(caseId) {
      try {
        const response = await fetch(`/api/cases/${caseId}`);
        const caseData = await response.json();

        document.getElementById('modal-title').textContent = caseData.name;

        const shareUrl = `${window.location.origin}/cases?id=${caseId}`;
        const shareText = `Check out this financial literacy case: ${caseData.name}`;

        document.getElementById('modal-body').innerHTML = `
          ${caseData.description ? `<p style="margin-bottom: 1.5rem;">${caseData.description}</p>` : ''}

          <div class="case-meta" style="margin-bottom: 1.5rem;">
            ${caseData.organization_name ? `
              <div>
                <strong>Partner Organization:</strong> ${caseData.organization_name}
              </div>
            ` : ''}
            <div>
              <strong>File Type:</strong> ${caseData.file_type.toUpperCase()}
            </div>
            <div>
              <strong>Added:</strong> ${new Date(caseData.created_at).toLocaleDateString()}
            </div>
          </div>

          ${caseData.tags && caseData.tags.length > 0 ? `
            <div style="margin-bottom: 1.5rem;">
              <strong>Topics:</strong>
              <div class="tags" style="margin-top: 0.5rem;">
                ${caseData.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
              </div>
            </div>
          ` : ''}

          <div style="margin-bottom: 1.5rem;">
            <a href="/${caseData.file_path}" download class="btn btn-success" style="padding: 0.75rem 1.5rem;">
              Download Case (${caseData.file_type.toUpperCase()})
            </a>
          </div>

          <div style="border-top: 1px solid var(--border-color); padding-top: 1.5rem;">
            <strong style="display: block; margin-bottom: 0.75rem;">Share this case:</strong>
            <div class="share-buttons">
              <a href="https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}"
                 target="_blank"
                 class="share-btn facebook">
                Facebook
              </a>
              <a href="https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(shareUrl)}"
                 target="_blank"
                 class="share-btn twitter">
                Twitter
              </a>
              <a href="https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(shareUrl)}"
                 target="_blank"
                 class="share-btn linkedin">
                LinkedIn
              </a>
              <a href="https://t.me/share/url?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(shareText)}"
                 target="_blank"
                 class="share-btn telegram">
                Telegram
              </a>
              <button onclick="copyShareLink('${shareUrl}')" class="btn btn-secondary" style="padding: 0.5rem 1rem;">
                Copy Link
              </button>
            </div>
          </div>
        `;

        document.getElementById('case-modal').classList.add('active');
      } catch (error) {
        console.error('Error loading case:', error);
        alert('Unable to load case details');
      }
    }

    // Close modal
    function closeModal() {
      document.getElementById('case-modal').classList.remove('active');
    }

    // Copy share link
    function copyShareLink(url) {
      navigator.clipboard.writeText(url).then(() => {
        alert('Link copied to clipboard!');
      }).catch(err => {
        console.error('Failed to copy:', err);
      });
    }

    // Close modal on background click
    document.getElementById('case-modal').addEventListener('click', (e) => {
      if (e.target.id === 'case-modal') {
        closeModal();
      }
    });

    // Initialize
    loadTags();
    loadCases();

    // Check if there's a case ID in URL
    const urlParams = new URLSearchParams(window.location.search);
    const caseId = urlParams.get('id');
    if (caseId) {
      viewCase(caseId);
    }
  </script>
</body>
</html>
